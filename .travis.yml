language: node_js
dist: trusty
node_js:
- '10.14'

branches:
  only:
    - master
    - /^greenkeeper/.*$/
    - /^v?[0-9]+.[0-9]+.[0-9]+(-.*)?$/

cache:
  directories:
  - "$HOME/.npm"
  - "$HOME/.mongodb/versions"

jobs:
  include:
    - stage: test
      env:
      - MONGODB_VERSION=3.2.13
      before_script:
      - npm install -g mongodb-runner
      - mongodb-runner start
      script:
      - npm run lint
      - npm test -- --maxWorkers=4
      - npm run integration
      after_script: ./node_modules/codecov/bin/codecov -f ./coverage/coverage-final.json && rm -rf ./coverage
    # release on github latest branch
    - stage: release
      env:
      -
      before_script: skip
      after_script: skip
      script:
      - npm run release_docs
      deploy:
        - provider: pages
          skip_cleanup: true
          github_token:
            secure: YU2lUqmW036AHBRu7xO/AwEeQ900Q/5O6FL96ZqWEfD7Gadaq4iapkNvhPR0HcZYRHqQV2/2LCHVnhd0dbj0ShkmVIHdQE7O+MF+j0v0GIVc8FPTPe1/d2Hy4apSWNe6FeCrYKVeliAu+ZqvNuFLhVmYvIeJdlJrMGOb6P76UZXRDv2srXhq4uBcCVUJuTajyyd5ttJfcNapymTP+xzEDYc7Hr4LJaubmv/wVD/xwPBbvfYFuBqysUpkPKi/ODlQbB0ybYh2fFnX71WUyFUGbtB5xI9ma951Zp4v3t73c31uUl27dJaHzO62EtVTdcUKAa804EtAtsvpeJWMVWKUgigm9UZcXdEwKa79fl5nLaq34lrSktAYOkexwPqYj+vbS6sn52JrluSxLE+4cEke7tYbnJ9X12SAQXKgcXY3n30+6gKf9RVqYdlNsYpEAqKVIDb6SlEkk86dP+uIg/XXb5RKEwxbDXnb6xdl9JRc+GTbeeY3/vg2h9QTdmFVblPtBhHrNenQYP/BS0n+EfUnAIBKqRmQgyhao3SiY5FMACM8higI2Lvvhpq46pDhXqsexYCz5F008C6YXGDh5gC93rJFec0pjh55DNdQu6uw3YMQ5jtf3QUXoPAoMFud3cTulMlnjC1WZG8QbqER8dzUZ4TcaQUdzribJI/mRriheBg=
          local_dir: docs/
          on:
            all_branches: true
        - provider: npm
          skip_cleanup: true
          api_key: $NPM_TOKEN
          email: npm@parseplatform.org
          on:
            tags: true
            all_branches: true
            repo: parse-community/Parse-SDK-JS
